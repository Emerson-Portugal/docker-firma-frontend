import{a as re,b as ie}from"./chunk-KJEGAV32.js";import{a as te}from"./chunk-RNQRIRRX.js";import{a as W}from"./chunk-WTW5RUH2.js";import{c as V,e as O,g as $}from"./chunk-FPNHGTLK.js";import{a as X,b as Y}from"./chunk-DX5THWTO.js";import{a as Z,b as ee}from"./chunk-Q5BYMEUU.js";import{a as se}from"./chunk-SAF4IUW2.js";import{b as f,p as G,q as J,r as Q}from"./chunk-RS23IZFS.js";import{Y as x,aa as q}from"./chunk-OUHVS6X7.js";import{a as K}from"./chunk-XLKPKAOX.js";import{C as L,D as M,l as A,o as j,s as z,z as H}from"./chunk-ITE25VCI.js";import{Ab as y,Bb as d,Ca as B,Ga as p,Kb as F,L as E,Pb as u,Q as a,Ta as P,V as b,W as S,Wb as T,Za as c,ec as U,fc as N,ic as k,k as D,mb as s,nb as o,ob as l,pb as g,tb as I,ub as R,v as C,wb as _}from"./chunk-TKL4FGBT.js";import{e as ae}from"./chunk-EQDQRRRY.js";var v=class i{http=a(M);tokenSrv=a(K);sign(e){let t=`${f.BASE_URL}/empleado/firmar/${e}`;return this.http.post(t,{},{headers:this.authHeaders()}).pipe(C(r=>D(()=>r)))}isPrevUnsignedError(e){return e instanceof L&&e.status===400&&!!e.error?.detail?.error&&e.error.detail.error==="documento_anterior_sin_firmar"}readableError(e){return e?.error?.detail?.mensaje?e.error.detail.mensaje:typeof e?.error=="string"?e.error:"El documento ya ha sido firmado previamente."}authHeaders(){let e=new H({Accept:"application/json"}),t=this.tokenSrv.getToken();return t&&(e=e.set("Authorization",`Bearer ${t}`)),e}static \u0275fac=function(t){return new(t||i)};static \u0275prov=E({token:i,factory:i.\u0275fac,providedIn:"root"})};var m=ae(se());function me(i,e){if(i&1){let t=_();o(0,"div",14)(1,"p-button",15),y("click",function(){b(t);let n=d();return S(n.home())}),l(),o(2,"span",16),u(3,"Firmar Boletas"),l()()}}function pe(i,e){if(i&1&&(g(0,"p-tag",17),U(1,"titlecase")),i&2){let t=d();s("value",N(1,2,(t.documento==null?null:t.documento.estado)||""))("severity",t.getSeverity(t.documento==null?null:t.documento.estado))}}function ce(i,e){if(i&1){let t=_();o(0,"button",18),y("click",function(){b(t);let n=d();return S(n.firmarDocumento())}),l()}i&2&&s("severity","danger")("raised",!0)}function de(i,e){i&1&&g(0,"p-progressBar",19)}function ue(i,e){if(i&1&&(I(0),o(1,"div",20)(2,"div",21)(3,"object",22)(4,"div",23)(5,"span"),u(6,"Tu navegador no puede mostrar el PDF embebido."),l()()()()(),R()),i&2){let t=d();p(3),s("data",t.pdfUrlSafe,B)}}function fe(i,e){i&1&&(o(0,"div",24),u(1,"No hay PDF para mostrar."),l())}var ne=class i{route=a(O);router=a($);sanitizer=a(V);docSvc=a(te);msg=a(x);signSrv=a(v);documento=null;pdfUrlSafe=null;loading=!0;isSigning=!1;normalizeDoc=e=>{let t=typeof e?.id=="string"?Number(e.id):Number(e?.id),r=e?.nombre_archivo??e?.nombre??"",n=(e?.ruta_archivo??e?.ruta??"").toString().replace(/\\/g,"/");return{id:t,nombre_archivo:r,ruta_archivo:n||void 0,ruta:e?.ruta??void 0,estado:e?.estado??void 0,nombre_usuario:e?.nombre_usuario??void 0,subido_en:e?.subido_en??e?.fecha_creacion??void 0}};ngOnInit(){let e=this.router.getCurrentNavigation()?.extras?.state?.doc||window.history.state?.doc;if(e){this.setDocumento(this.normalizeDoc(e));return}let t=Number(this.route.snapshot.paramMap.get("id"));if(!Number.isFinite(t)){this.msg.add({severity:"warn",summary:"Aviso",detail:"ID inv\xE1lido"}),this.router.navigate(["/signature/sign-ballots/dashboard"]);return}this.docSvc.getDocumentos().subscribe({next:r=>{let w=(Array.isArray(r)?r:[]).map(this.normalizeDoc).find(oe=>oe.id===t);w?this.setDocumento(w):(this.loading=!1,this.msg.add({severity:"info",summary:"Sin PDF",detail:"No se encontr\xF3 el documento."}))},error:r=>{this.loading=!1,this.msg.add({severity:"error",summary:"Error",detail:"No se pudo cargar el documento."}),console.error(r)}})}setDocumento(e){this.documento=e;let t=e.ruta_archivo??e.ruta??"";if(!t){this.loading=!1,this.pdfUrlSafe=null;return}let r=t.split("/").map(encodeURIComponent).join("/"),h=`${(f.BASE_URL_PDF||"").replace(/\/+$/,"")}/${r}#view=FitH&toolbar=1&navpanes=0`;console.log("[SignBallots] BASE_URL_PDF =",f.BASE_URL_PDF),console.log("[SignBallots] rawPath     =",t),console.log("[SignBallots] encodedPath =",r),console.log("[SignBallots] iframe URL  =",h),this.pdfUrlSafe=this.sanitizer.bypassSecurityTrustResourceUrl(h),this.loading=!1}getSeverity(e){return e==="firmado"?"success":e==="pendiente"?"danger":"info"}firmarDocumento(){if(this.isSigning)return;let e=this.router.url.split("/").filter(Boolean).pop(),t=Number(e);if(!t||Number.isNaN(t)){m.default.fire("Sin ID","No se encontr\xF3 el ID del documento en la URL.","error");return}this.isSigning=!0,m.default.fire({title:"Firmando PDF",html:"Esto puede tardar unos segundos\u2026",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>m.default.showLoading()}),this.signSrv.sign(t).subscribe({next:()=>{this.isSigning=!1,m.default.close(),this.documento&&(this.documento.estado="firmado"),m.default.fire({title:"\xA1Firmado!",text:"Documento firmado correctamente.",icon:"success",confirmButtonText:"Aceptar",allowOutsideClick:!1}).then(r=>{this.router.navigate(["/signature/sign-ballots/dashboard"])})},error:r=>{if(this.isSigning=!1,m.default.close(),this.signSrv.isPrevUnsignedError(r)){let n=r.error.detail.documento_anterior;m.default.fire("Firma bloqueada",`Debes firmar primero: ${n.nombre} (fecha: ${n.fecha}).`,"warning")}else{let n=this.signSrv.readableError(r);m.default.fire("Error al firmar",n,"error")}}})}home(){this.router.navigate(["/signature/sign-ballots/dashboard"])}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=P({type:i,selectors:[["app-sign-ballots"]],features:[T([x])],decls:16,vars:7,consts:[["emptyState",""],[1,"flex","flex-col"],["message","Cargando documentos...",3,"isLoading"],[1,"my-3"],["pTemplate","header"],[1,"flex"],[1,"flex","items-center","gap-2"],[1,"text-sm","font-medium"],[3,"value","severity",4,"ngIf"],[1,"flex","flex-col","gap-2","mt-3","absolute","right-5","top-18","md:relative","md:top-0","md:right-0","md:flex-row"],["pButton","","label","Firmar PDF","icon","pi pi-pencil","size","small","styleClass","whitespace-nowrap px-4 h-9 rounded-md",3,"severity","raised","click",4,"ngIf"],[1,"my-3",3,"header"],["mode","indeterminate","styleClass","mb-3",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"flex","items-center"],["icon","pi pi-arrow-left","styleClass","p-button-danger p-button-rounded p-button-text mr-2",3,"click"],[1,"text-lg","font-semibold"],[3,"value","severity"],["pButton","","label","Firmar PDF","icon","pi pi-pencil","size","small","styleClass","whitespace-nowrap px-4 h-9 rounded-md",3,"click","severity","raised"],["mode","indeterminate","styleClass","mb-3"],[1,"w-full","flex","justify-center"],[1,"w-full","max-w-screen-lg"],["type","application/pdf",1,"w-full","h-[65vh]",3,"data"],[1,"p-4","text-sm","text-surface-500","flex","flex-col","gap-3","items-start"],[1,"text-surface-500","text-sm"]],template:function(t,r){if(t&1&&(o(0,"div",1),g(1,"app-loading",2),o(2,"p-card",3),c(3,me,4,0,"ng-template",4),o(4,"div",5)(5,"div",6)(6,"span",7),u(7,"Estado:"),l(),c(8,pe,2,4,"p-tag",8),l()(),o(9,"div",9),c(10,ce,1,2,"button",10),l()(),o(11,"p-card",11),c(12,de,1,0,"p-progressBar",12)(13,ue,7,1,"ng-container",13)(14,fe,2,0,"ng-template",null,0,k),l()()),t&2){let n=F(15);p(),s("isLoading",r.loading),p(7),s("ngIf",r.documento==null?null:r.documento.estado),p(2),s("ngIf",(r.documento==null?null:r.documento.estado)!=="firmado"),p(),s("header",(r.documento==null?null:r.documento.nombre_archivo)||"Previsualizaci\xF3n"),p(),s("ngIf",r.loading),p(),s("ngIf",!r.loading&&r.pdfUrlSafe)("ngIfElse",n)}},dependencies:[z,A,Y,X,q,Q,G,J,ee,Z,ie,re,W,j],styles:[".viewer-frame[_ngcontent-%COMP%]{width:100%;height:calc(100vh - 12rem);border:1px solid var(--surface-border);border-radius:var(--content-border-radius)}"]})};export{ne as SignBallotsComponent};
