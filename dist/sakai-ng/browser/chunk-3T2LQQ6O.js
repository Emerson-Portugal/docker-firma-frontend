import{a as re,b as ie}from"./chunk-54UEE46Z.js";import{a as te}from"./chunk-TW7D42UK.js";import{a as W}from"./chunk-WTW5RUH2.js";import{c as V,e as O,g as $}from"./chunk-FPNHGTLK.js";import{a as X,b as Y}from"./chunk-2GZEO4PA.js";import{a as Z,b as ee}from"./chunk-XLYG6UBL.js";import{a as se}from"./chunk-SAF4IUW2.js";import{b as f,p as G,q as J,r as Q}from"./chunk-77BGPX7E.js";import{Y as x,aa as q}from"./chunk-OUHVS6X7.js";import{a as K}from"./chunk-XLKPKAOX.js";import{C as M,D as L,l as A,o as H,s as j,z}from"./chunk-ITE25VCI.js";import{Ab as y,Bb as d,Ca as B,Ga as p,Kb as F,L as E,Pb as c,Q as o,Ta as P,V as b,W as S,Wb as N,Za as u,ec as T,fc as U,ic as k,k as D,mb as a,nb as n,ob as s,pb as g,tb as I,ub as R,v as C,wb as _}from"./chunk-TKL4FGBT.js";import{e as ae}from"./chunk-EQDQRRRY.js";var v=class i{http=o(L);tokenSrv=o(K);sign(e){let t=`${f.BASE_URL}/empleado/firmar/${e}`;return this.http.post(t,{},{headers:this.authHeaders()}).pipe(C(r=>D(()=>r)))}isPrevUnsignedError(e){return e instanceof M&&e.status===400&&!!e.error?.detail?.error&&e.error.detail.error==="documento_anterior_sin_firmar"}readableError(e){return e?.error?.detail?.mensaje?e.error.detail.mensaje:typeof e?.error=="string"?e.error:"El documento ya ha sido firmado previamente."}authHeaders(){let e=new z({Accept:"application/json"}),t=this.tokenSrv.getToken();return t&&(e=e.set("Authorization",`Bearer ${t}`)),e}static \u0275fac=function(t){return new(t||i)};static \u0275prov=E({token:i,factory:i.\u0275fac,providedIn:"root"})};var m=ae(se());function me(i,e){if(i&1){let t=_();n(0,"div",14)(1,"p-button",15),y("click",function(){b(t);let l=d();return S(l.home())}),s(),n(2,"span",16),c(3,"Firmar Boletas"),s()()}}function pe(i,e){if(i&1&&(g(0,"p-tag",17),T(1,"titlecase")),i&2){let t=d();a("value",U(1,2,(t.documento==null?null:t.documento.estado)||""))("severity",t.getSeverity(t.documento==null?null:t.documento.estado))}}function ue(i,e){if(i&1){let t=_();n(0,"button",18),y("click",function(){b(t);let l=d();return S(l.firmarDocumento())}),s()}i&2&&a("severity","danger")("raised",!0)}function de(i,e){i&1&&g(0,"p-progressBar",19)}function ce(i,e){if(i&1&&(I(0),n(1,"div",20)(2,"div",21)(3,"object",22)(4,"div",23)(5,"span"),c(6,"Tu navegador no puede mostrar el PDF embebido."),s()()()()(),R()),i&2){let t=d();p(3),a("data",t.pdfUrlSafe,B)}}function fe(i,e){i&1&&(n(0,"div",24),c(1,"No hay PDF para mostrar."),s())}var ne=class i{route=o(O);router=o($);sanitizer=o(V);docSvc=o(te);msg=o(x);signSrv=o(v);documento=null;pdfUrlSafe=null;loading=!0;isSigning=!1;normalizeDoc=e=>{let t=typeof e?.id=="string"?Number(e.id):Number(e?.id),r=e?.nombre_archivo??e?.nombre??"",l=(e?.ruta_archivo??e?.ruta??"").toString().replace(/\\/g,"/");return{id:t,nombre_archivo:r,ruta_archivo:l||void 0,ruta:e?.ruta??void 0,estado:e?.estado??void 0,nombre_usuario:e?.nombre_usuario??void 0,subido_en:e?.subido_en??e?.fecha_creacion??void 0}};ngOnInit(){let e=this.router.getCurrentNavigation()?.extras?.state?.doc||window.history.state?.doc;if(e){this.setDocumento(this.normalizeDoc(e));return}let t=Number(this.route.snapshot.paramMap.get("id"));if(!Number.isFinite(t)){this.msg.add({severity:"warn",summary:"Aviso",detail:"ID inv\xE1lido"}),this.router.navigate(["/signature/sign-ballots/dashboard"],{queryParamsHandling:"preserve"});return}this.docSvc.getDocumentos().subscribe({next:r=>{let w=(Array.isArray(r)?r:[]).map(this.normalizeDoc).find(oe=>oe.id===t);w?this.setDocumento(w):(this.loading=!1,this.msg.add({severity:"info",summary:"Sin PDF",detail:"No se encontr\xF3 el documento."}))},error:r=>{this.loading=!1,this.msg.add({severity:"error",summary:"Error",detail:"No se pudo cargar el documento."}),console.error(r)}})}setDocumento(e){this.documento=e;let t=e.ruta_archivo??e.ruta??"";if(!t){this.loading=!1,this.pdfUrlSafe=null;return}let r=t.split("/").map(encodeURIComponent).join("/"),h=`${(f.BASE_URL_PDF||"").replace(/\/+$/,"")}/${r}#view=FitH&toolbar=1&navpanes=0`;console.log("[SignBallots] BASE_URL_PDF =",f.BASE_URL_PDF),console.log("[SignBallots] rawPath     =",t),console.log("[SignBallots] encodedPath =",r),console.log("[SignBallots] iframe URL  =",h),this.pdfUrlSafe=this.sanitizer.bypassSecurityTrustResourceUrl(h),this.loading=!1}getSeverity(e){return e==="firmado"?"success":e==="pendiente"?"danger":"info"}firmarDocumento(){if(this.isSigning)return;let e=Number(this.route.snapshot.paramMap.get("id"));if(!e||Number.isNaN(e)){let t=this.router.url.split("/").filter(Boolean).pop()||"";e=Number((t.split("?")[0]||"").trim())}if(!e||Number.isNaN(e)){m.default.fire("Sin ID","No se encontr\xF3 el ID del documento en la URL.","error");return}this.isSigning=!0,m.default.fire({title:"Firmando PDF",html:"Esto puede tardar unos segundos\u2026",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>m.default.showLoading()}),this.signSrv.sign(e).subscribe({next:()=>{this.isSigning=!1,m.default.close(),this.documento&&(this.documento.estado="firmado"),m.default.fire({title:"\xA1Firmado!",text:"Documento firmado correctamente.",icon:"success",confirmButtonText:"Aceptar",allowOutsideClick:!1}).then(t=>{this.router.navigate(["/signature/sign-ballots/dashboard"],{queryParamsHandling:"preserve"})})},error:t=>{if(this.isSigning=!1,m.default.close(),this.signSrv.isPrevUnsignedError(t)){let r=t.error.detail.documento_anterior;m.default.fire("Firma bloqueada",`Debes firmar primero: ${r.nombre} (fecha: ${r.fecha}).`,"warning")}else{let r=this.signSrv.readableError(t);m.default.fire("Error al firmar",r,"error")}}})}home(){this.router.navigate(["/signature/sign-ballots/dashboard"],{queryParamsHandling:"preserve"})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=P({type:i,selectors:[["app-sign-ballots"]],features:[N([x])],decls:16,vars:7,consts:[["emptyState",""],[1,"flex","flex-col"],["message","Cargando documentos...",3,"isLoading"],[1,"my-3"],["pTemplate","header"],[1,"flex"],[1,"flex","items-center","gap-2"],[1,"text-sm","font-medium"],[3,"value","severity",4,"ngIf"],[1,"flex","flex-col","gap-2","mt-3","absolute","right-5","top-18","md:relative","md:top-0","md:right-0","md:flex-row"],["pButton","","label","Firmar PDF","icon","pi pi-pencil","size","small","styleClass","whitespace-nowrap px-4 h-9 rounded-md",3,"severity","raised","click",4,"ngIf"],[1,"my-3",3,"header"],["mode","indeterminate","styleClass","mb-3",4,"ngIf"],[4,"ngIf","ngIfElse"],[1,"flex","items-center"],["icon","pi pi-arrow-left","styleClass","p-button-danger p-button-rounded p-button-text mr-2",3,"click"],[1,"text-lg","font-semibold"],[3,"value","severity"],["pButton","","label","Firmar PDF","icon","pi pi-pencil","size","small","styleClass","whitespace-nowrap px-4 h-9 rounded-md",3,"click","severity","raised"],["mode","indeterminate","styleClass","mb-3"],[1,"w-full","flex","justify-center"],[1,"w-full","max-w-screen-lg"],["type","application/pdf",1,"w-full","h-[65vh]",3,"data"],[1,"p-4","text-sm","text-surface-500","flex","flex-col","gap-3","items-start"],[1,"text-surface-500","text-sm"]],template:function(t,r){if(t&1&&(n(0,"div",1),g(1,"app-loading",2),n(2,"p-card",3),u(3,me,4,0,"ng-template",4),n(4,"div",5)(5,"div",6)(6,"span",7),c(7,"Estado:"),s(),u(8,pe,2,4,"p-tag",8),s()(),n(9,"div",9),u(10,ue,1,2,"button",10),s()(),n(11,"p-card",11),u(12,de,1,0,"p-progressBar",12)(13,ce,7,1,"ng-container",13)(14,fe,2,0,"ng-template",null,0,k),s()()),t&2){let l=F(15);p(),a("isLoading",r.loading),p(7),a("ngIf",r.documento==null?null:r.documento.estado),p(2),a("ngIf",(r.documento==null?null:r.documento.estado)!=="firmado"),p(),a("header",(r.documento==null?null:r.documento.nombre_archivo)||"Previsualizaci\xF3n"),p(),a("ngIf",r.loading),p(),a("ngIf",!r.loading&&r.pdfUrlSafe)("ngIfElse",l)}},dependencies:[j,A,Y,X,q,Q,G,J,ee,Z,ie,re,W,H],styles:[".viewer-frame[_ngcontent-%COMP%]{width:100%;height:calc(100vh - 12rem);border:1px solid var(--surface-border);border-radius:var(--content-border-radius)}"]})};export{ne as SignBallotsComponent};
