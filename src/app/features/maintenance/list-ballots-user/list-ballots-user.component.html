<div class="flex flex-col">
    <!-- Loading Overlay -->
    <app-loading [isLoading]="loading" message="Cargando documentos..."></app-loading>

    <div class="card relative">
        <!-- Encabezado -->
        <div class="flex items-center mb-3">
            <!-- Si estamos en vista de documentos mostramos botón atrás -->
            <p-button
                *ngIf="!showYearView"
                icon="pi pi-arrow-left"
                (click)="goBackToYears()"
                styleClass="p-button-danger p-button-rounded p-button-text mr-2">
            </p-button>

            <!-- Si estamos en vista de años mostramos botón home -->
            <p-button
                *ngIf="showYearView"
                icon="pi pi-arrow-left"
                (click)="home()"
                styleClass="p-button-danger p-button-rounded p-button-text mr-2">
            </p-button>

            <div class="font-semibold text-xl">
                {{ showYearView ? 'Mis Documentos' : 'Documentos del año ' + selectedYear }}
            </div>
        </div>

        <!-- Vista de AÑOS -->
        <div *ngIf="showYearView" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4 justify-center">
            <div
                *ngFor="let year of years"
                class="p-6 border rounded shadow hover:shadow-md cursor-pointer transition-transform transform hover:-translate-y-1 bg-white flex flex-col items-center"
                (click)="selectYear(year)">
                <i class="pi pi-folder text-5xl text-primary-500 mb-3"></i>
                <span class="font-semibold text-lg">{{ year }}</span>
            </div>
        </div>

        <!-- Vista de Documentos -->
        <div *ngIf="showDocumentView">
            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Filtro por estado -->
                <div class="flex flex-col">
                    <label class="block text-600 text-sm font-medium mb-2">Estado</label>
                    <p-select [options]="estadoOptions" [(ngModel)]="estadoFiltro" (onChange)="aplicarFiltros()" optionLabel="label" optionValue="value" [showClear]="true" placeholder="Filtrar por estado" styleClass="w-full"></p-select>
                </div>

                <!-- Filtro por mes -->
                <div class="flex flex-col">
                    <label class="block text-600 text-sm font-medium mb-2">Mes</label>
                    <p-select [options]="meses" [(ngModel)]="mesFiltro" (onChange)="aplicarFiltros()" optionLabel="label" optionValue="value" [showClear]="true" placeholder="Filtrar por mes" styleClass="w-full"></p-select>
                </div>

                <div class="flex items-end gap-2">
                    <!-- Ordenar por -->
                    <div class="flex-1 flex flex-col">
                        <label class="block text-600 text-sm font-medium mb-2">Ordenar por</label>
                        <p-select [options]="opcionesOrden" [(ngModel)]="ordenarPor" (onChange)="aplicarFiltros()" optionLabel="label" optionValue="value" styleClass="w-full"></p-select>
                    </div>

                    <!-- Botón Limpiar Filtros -->
                    <div class="flex items-end">
                        <button pButton type="button" icon="pi pi-filter-slash" label="Limpiar" (click)="limpiarFiltros()" class="p-button-text p-button-sm" style="height: 36px; margin-bottom: 2px"></button>
                    </div>
                </div>
            </div>

            <!-- DataView -->
            <p-dataview [value]="documentosFiltrados" layout="list" [paginator]="true" [rows]="rows" [rowsPerPageOptions]="[5, 10, 25, 50]" [first]="first" [alwaysShowPaginator]="false" paginatorPosition="both">
                <!-- Vista LISTA -->
                <ng-template #list let-items>
                    <div class="flex flex-col">
                        <div *ngFor="let doc of items; let i = index; trackBy: trackDoc" class="flex flex-col p-6 gap-3" [ngClass]="{ 'border-t border-surface': i !== 0 }">
                            <!-- Nombre -->
                            <div class="text-lg font-medium break-all text-blue-600">
                                {{ doc.nombre_archivo }}
                            </div>

                            <!-- Metadatos -->
                            <div class="mt-1 text-surface-500 text-sm">Usuario: {{ doc.nombre_usuario }}</div>
                            <div class="text-surface-500 text-sm">Subido: {{ doc.subido_en | date: 'medium' }}</div>
                            <div class="text-surface-500 text-sm">
                                Firmado:
                                {{ doc.firmado_en ? (doc.firmado_en | date: 'medium') : '—' }}
                            </div>

                            <!-- Acciones -->
                            <div class="mt-2 flex items-center gap-3 flex-nowrap">
                                <p-tag class="shrink-0" [value]="doc.estado | titlecase" [severity]="getSeverity(doc.estado)"></p-tag>

                                <span class="grow"></span>

                                <ng-container *ngIf="doc.estado === 'firmado'; else firmarButton">
                                    <p-button icon="pi pi-eye" label="Ver" severity="info" raised size="small" (onClick)="verDocumento(doc)" class="shrink-0 whitespace-nowrap px-5 h-9 rounded-md"></p-button>
                                </ng-container>

                                <ng-template #firmarButton>
                                    <p-button
                                        [icon]="validando[doc.id] ? 'pi pi-spin pi-spinner' : 'pi pi-pencil'"
                                        [label]="validando[doc.id] ? 'Validando...' : 'Firmar'"
                                        severity="success"
                                        raised
                                        size="small"
                                        (onClick)="descargar(doc)"
                                        [disabled]="validando[doc.id]"
                                        class="shrink-0 whitespace-nowrap px-5 h-9 rounded-md"
                                    ></p-button>
                                </ng-template>
                            </div>
                        </div>
                    </div>
                </ng-template>

                <!-- Vacío -->
                <ng-template pTemplate="empty">
                    <div class="p-6 text-center text-surface-500">No hay facturas.</div>
                </ng-template>
            </p-dataview>

            <div *ngIf="error" class="mt-3 text-red-600">{{ error }}</div>
        </div>
    </div>
</div>
